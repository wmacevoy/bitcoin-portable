#!/bin/bash

. "$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )/config.sh"

src="$BITCOIN_PORTABLE_URL"
dir="bitcoin-$BITCOIN_PORTABLE_VERSION-$BITCOIN_PORTABLE_OS"

tries=0
while [ ! -r "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE.sha256" ]
do
    tries=$(($tries + 1))
    [ $tries -lt 2 ] || BITCOIN_PORTABLE_ERR "failed to find checksum."

    echo "downloading $BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE.sha256"
    /bin/rm -rf "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE.sha256"
    BITCOIN_PORTABLE_CAT "$BITCOIN_PORTABLE_URL_SHA256" \
        | grep bitcoin-$BITCOIN_PORTABLE_VERSION-$BITCOIN_PORTABLE_OS$BITCOIN_PORTABLE_ARCHIVE_EXTENSION \
        | cut -d ' ' -f1 \
        > "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE.sha256"
done

tries=0
while ! (test -r "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE" && \
    cat "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE" | BITCOIN_PORTABLE_SHA256 | diff -q - "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE.sha256")
do
    tries=$(($tries + 1))
    [ $tries -lt 2 ] || BITCOIN_PORTABLE_ERR "failed to download $BITCOIN_PORTABLE_ARCHIVE"

    echo "downloading $BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE..."
    /bin/rm -rf "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE"
    /bin/rm -rf "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR"
    BITCOIN_PORTABLE_CAT "$BITCOIN_PORTABLE_URL" >"$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE"
done

if [ ! -d "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR" ]
then
    echo "extracting to $BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR..."
    /bin/rm -rf "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR"
    /bin/rm -rf "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR.in-progress"
    mkdir -p "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR.in-progress"
    if [ "$BITCOIN_PORTABLE_ARCHIVE_EXTENSION" == ".tar.gz" ]
    then
        tar --strip-components=1 -zxf "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE" -C "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR.in-progress"
        mv "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR.in-progress" "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR"
    else
        unzip -d "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR.in-progress" "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_ARCHIVE"
        mv "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR.in-progress/bitcoin-$BITCOIN_PORTABLE_VERSION" "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR"
        /bin/rm -rf "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR.in-progress"
    fi
    echo "$BITCOIN_PORTABLE_DIR/$BITCOIN_PORTABLE_SUBDIR extracted."
fi

mkdir -p "$BITCOIN_PORTABLE_DIR/data"


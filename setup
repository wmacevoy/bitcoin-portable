#!/bin/bash


ERR() { 
    echo "$@" 1>&2
    exit 1
}

CAT() {
    if which curl > /dev/null
    then
    	if curl "$@"
        then
            return
        fi
    fi
    if which wget > /dev/null
    then
    	if wget -O - "$@"
        then
            return
        fi
    fi
    ERR "CAT $@ failed."
}

at="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

. "$at/config.sh"

src="$BITCOIN_CORE_URL"
dir="bitcoin-$BITCOIN_CORE_VERSION-$BITCOIN_CORE_OS"

if [ "$BITCOIN_CORE_OS" != "win64" ]
then
    archive_extension="tar.gz"
    archive="$dir.tar.gz"
    archiver=tar
else
    archive_extension="zip"
    archive="$dir.zip"
    archiver=zip
fi

tries=0
while ! grep -q $archive "$at/$archive.sha256" > /dev/null
do
    tries=$(($tries + 1))
    [ $tries -lt 2 ] || ERR "failed to find checksum."

    echo "downloading $at/$archive.sha256"
    /bin/rm -rf "$at/$archive.sha256"
    CAT "$BITCOIN_CORE_URL_SHA256" \
        | grep bitcoin-$BITCOIN_CORE_VERSION-$BITCOIN_CORE_OS.$archive_extension \
        | sed -e "s/bitcoin-$BITCOIN_CORE_VERSION-$BITCOIN_CORE_OS.$archive_extension/$archive/" \
        > "$at/$archive.sha256"
done

tries=0
while ! (test -r "$at/$archive" && cd "$at" && shasum -a 256 -c "$archive.sha256")
do
    tries=$(($tries + 1))
    [ $tries -lt 2 ] || ERR "failed to download $archive"

    echo "downloading $at/$archive..."
    /bin/rm -rf "$at/$archive"
    /bin/rm -rf "$at/$dir"
    /bin/rm -rf "$at/bitcoin-$BITCOIN_CORE_OS"
    CAT "$BITCOIN_CORE_URL" >"$at/$archive"
done

if [ ! -d "$at/$dir" ]
then
    echo "extracting to $at/$dir..."
    /bin/rm -rf "$at/$dir"
    /bin/rm -rf "$at/$dir.in-progress"
    /bin/rm -rf "$at/bitcoin-$BITCOIN_CORE_OS"    
    mkdir -p "$at/$dir.in-progress"
    if [ "$archiver" == "tar" ]
    then
        tar --strip-components=1 -zxf "$at/$archive" -C "$at/$dir.in-progress"
        mv "$at/$dir.in-progress" "$at/$dir"
    else
        unzip -d "$at/$dir.in-progress" "$at/$archive"
        mv "$at/$dir.in-progress/bitcoin-$BITCOIN_CORE_VERSION" "$at/$dir"
        /bin/rm -rf "$at/$dir.in-progress"
    fi
    echo "$at/$dir extracted."
fi

(cd "$at" && mkdir -p data)

